---
- name: wgdashboard | Fail if distro is not supported
  ansible.builtin.fail:
    msg: "Distribution '{{ ansible_distribution }}' is not supported. Supported: Debian, Ubuntu"
  when: ansible_distribution not in ['Debian', 'Ubuntu']

- name: wgdashboard | Install dependencies
  ansible.builtin.apt:
    name:
      - git
      - python3
      - python3-pip
      - python3-venv
      - net-tools
    state: present
    update_cache: true

- name: wgdashboard | Check if WGDashboard is already installed
  ansible.builtin.stat:
    path: "{{ wgdashboard_install_dir }}/src/wgd.sh"
  register: wgdashboard_installed

- name: wgdashboard | Get current installed version
  ansible.builtin.shell: |
    cd {{ wgdashboard_install_dir }} && git describe --tags --abbrev=0 2>/dev/null || echo "unknown"
  register: wgdashboard_current_version
  changed_when: false
  failed_when: false
  when: wgdashboard_installed.stat.exists

- name: wgdashboard | Display installation status
  ansible.builtin.debug:
    msg: "WGDashboard is {{ 'installed (version ' + wgdashboard_current_version.stdout | default('unknown') + ')' if wgdashboard_installed.stat.exists else 'not installed' }}."

- name: wgdashboard | Check if update is needed
  ansible.builtin.set_fact:
    wgdashboard_needs_install: "{{ not wgdashboard_installed.stat.exists }}"
    wgdashboard_needs_update: "{{ wgdashboard_installed.stat.exists and (wgdashboard_current_version.stdout | default('') != wgdashboard_version) }}"

- name: wgdashboard | Display version information
  ansible.builtin.debug:
    msg: |
      Current version: {{ wgdashboard_current_version.stdout | default('not installed') }}
      Target version: {{ wgdashboard_version }}
      Needs install: {{ wgdashboard_needs_install }}
      Needs update: {{ wgdashboard_needs_update }}

## Fresh install
- name: wgdashboard | Clone WGDashboard repository (fresh install)
  ansible.builtin.git:
    repo: https://github.com/WGDashboard/WGDashboard.git
    dest: "{{ wgdashboard_install_dir }}"
    version: "{{ wgdashboard_version }}"
    force: true
  when: wgdashboard_needs_install

- name: wgdashboard | Make wgd.sh executable (fresh install)
  ansible.builtin.file:
    path: "{{ wgdashboard_install_dir }}/src/wgd.sh"
    mode: "0755"
  when: wgdashboard_needs_install

- name: wgdashboard | Run WGDashboard install script (fresh install)
  ansible.builtin.shell: |
    cd {{ wgdashboard_install_dir }}/src
    ./wgd.sh install
  when: wgdashboard_needs_install

## Update existing installation
- name: wgdashboard | Stop WGDashboard before update
  ansible.builtin.systemd:
    name: wg-dashboard
    state: stopped
  when: wgdashboard_needs_update
  ignore_errors: true

- name: wgdashboard | Update WGDashboard
  ansible.builtin.shell: |
    cd {{ wgdashboard_install_dir }}
    git fetch --tags
    git checkout {{ wgdashboard_version }}
    chmod +x src/wgd.sh
    cd src
    ./wgd.sh install
  when: wgdashboard_needs_update
  notify: Restart WGDashboard

## Fix permissions after wgd.sh install (it sets 755 on /etc/wireguard files)
- name: wgdashboard | Find private key files
  ansible.builtin.find:
    paths: /etc/wireguard
    patterns: "*_privatekey"
  register: privatekey_files

- name: wgdashboard | Find public key files
  ansible.builtin.find:
    paths: /etc/wireguard
    patterns: "*_publickey"
  register: publickey_files

- name: wgdashboard | Find config files
  ansible.builtin.find:
    paths: /etc/wireguard
    patterns: "*.conf"
  register: config_files

- name: wgdashboard | Fix private key permissions
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ privatekey_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: wgdashboard | Fix public key permissions
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ publickey_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: wgdashboard | Fix config file permissions
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ config_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: wgdashboard | Deploy systemd service
  ansible.builtin.template:
    src: wg-dashboard.service.j2
    dest: /etc/systemd/system/wg-dashboard.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart WGDashboard

- name: wgdashboard | Enable and start WGDashboard
  ansible.builtin.systemd:
    name: wg-dashboard
    enabled: true
    state: started
    daemon_reload: true

- name: wgdashboard | Display access information
  ansible.builtin.debug:
    msg: |
      WGDashboard {{ wgdashboard_version }} installed successfully!

      Access: http://127.0.0.1:10086

      Default credentials:
        Username: admin
        Password: admin

      CHANGE PASSWORD AFTER FIRST LOGIN!

      SSH tunnel for remote access:
        ssh user@{{ inventory_hostname }} -L 10086:127.0.0.1:10086 -N
        Then open: http://localhost:10086
