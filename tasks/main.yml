---
- name: wgdashboard | Fail if distro is not supported
  ansible.builtin.fail:
    msg: "Distribution '{{ ansible_facts['distribution'] }}' is not supported. Supported: Debian, Ubuntu"
  when: ansible_facts['distribution'] not in ['Debian', 'Ubuntu']

- name: wgdashboard | Install dependencies
  ansible.builtin.apt:
    name:
      - git
      - python3
      - python3-pip
      - python3-venv
      - net-tools
    state: present
    update_cache: true

- name: wgdashboard | Check if WGDashboard is already installed
  ansible.builtin.stat:
    path: "{{ wgdashboard_install_dir }}/src/wgd.sh"
  register: wgdashboard_installed

- name: wgdashboard | Get current installed version
  ansible.builtin.shell: |
    cd {{ wgdashboard_install_dir }} && git describe --tags --abbrev=0 2>/dev/null || echo "unknown"
  register: wgdashboard_current_version
  changed_when: false
  failed_when: false
  when: wgdashboard_installed.stat.exists

- name: wgdashboard | Display installation status
  ansible.builtin.debug:
    msg: "WGDashboard is {{ 'installed (version ' + wgdashboard_current_version.stdout | default('unknown') + ')' if wgdashboard_installed.stat.exists else 'not installed' }}."

- name: wgdashboard | Check if update is needed
  ansible.builtin.set_fact:
    wgdashboard_needs_install: "{{ not wgdashboard_installed.stat.exists }}"
    wgdashboard_needs_update: "{{ wgdashboard_installed.stat.exists and (wgdashboard_current_version.stdout | default('') != wgdashboard_version) }}"

- name: wgdashboard | Display version information
  ansible.builtin.debug:
    msg: |
      Current version: {{ wgdashboard_current_version.stdout | default('not installed') }}
      Target version: {{ wgdashboard_version }}
      Needs install: {{ wgdashboard_needs_install }}
      Needs update: {{ wgdashboard_needs_update }}

## Fresh install
- name: wgdashboard | Clone WGDashboard repository (fresh install)
  ansible.builtin.git:
    repo: https://github.com/WGDashboard/WGDashboard.git
    dest: "{{ wgdashboard_install_dir }}"
    version: "{{ wgdashboard_version }}"
    force: true
  when: wgdashboard_needs_install

- name: wgdashboard | Make wgd.sh executable (fresh install)
  ansible.builtin.file:
    path: "{{ wgdashboard_install_dir }}/src/wgd.sh"
    mode: "0755"
  when: wgdashboard_needs_install

- name: wgdashboard | Run WGDashboard install script (fresh install)
  ansible.builtin.shell: |
    cd {{ wgdashboard_install_dir }}/src
    ./wgd.sh install
  register: wgd_install_result
  changed_when: true
  when: wgdashboard_needs_install

## Configure wg-dashboard.ini (only on fresh install)
- name: wgdashboard | Configure admin username
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Account
    option: username
    value: "{{ wgdashboard_admin_user }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure admin password
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Account
    option: password
    value: "{{ wgdashboard_admin_pass_hash }}"
    mode: "0600"
  when:
    - wgdashboard_needs_install
    - wgdashboard_admin_pass_hash != ""
  no_log: true
  notify: Restart WGDashboard

- name: wgdashboard | Configure enable totp
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Account
    option: enable_totp
    value: "{{ wgdashboard_enable_totp }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure totp verified
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Account
    option: totp_verified
    value: "{{ wgdashboard_totp_verified }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure app_ip
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Server
    option: app_ip
    value: "{{ wgdashboard_app_ip }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure peer_global_dns
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Peers
    option: peer_global_dns
    value: "{{ wgdashboard_peer_global_dns }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure peer_mtu
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Peers
    option: peer_mtu
    value: "{{ wgdashboard_peer_mtu }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure peer_keep_alive
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Peers
    option: peer_keep_alive
    value: "{{ wgdashboard_peer_keep_alive }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure autostart interface
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: WireGuardConfiguration
    option: autostart
    value: "{{ wgdashboard_wg_interface }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

- name: wgdashboard | Configure welcome session
  community.general.ini_file:
    path: "{{ wgdashboard_install_dir }}/src/wg-dashboard.ini"
    section: Other
    option: welcome_session
    value: "{{ wgdashboard_welcome_session }}"
    mode: "0600"
  when: wgdashboard_needs_install
  notify: Restart WGDashboard

## Update existing installation
- name: wgdashboard | Stop WGDashboard before update
  ansible.builtin.systemd:
    name: wg-dashboard
    state: stopped
  when: wgdashboard_needs_update
  failed_when: false

- name: wgdashboard | Update WGDashboard
  ansible.builtin.shell: |
    cd {{ wgdashboard_install_dir }}
    git fetch --tags
    git checkout {{ wgdashboard_version }}
    chmod +x src/wgd.sh
    cd src
    ./wgd.sh install
  register: wgd_update_result
  changed_when: true
  when: wgdashboard_needs_update
  notify: Restart WGDashboard

## Fix permissions after wgd.sh install (it sets 755 on /etc/wireguard files)
- name: wgdashboard | Find private key files
  ansible.builtin.find:
    paths: /etc/wireguard
    patterns: "*_privatekey"
  register: privatekey_files

- name: wgdashboard | Find public key files
  ansible.builtin.find:
    paths: /etc/wireguard
    patterns: "*_publickey"
  register: publickey_files

- name: wgdashboard | Find config files
  ansible.builtin.find:
    paths: /etc/wireguard
    patterns: "*.conf"
  register: config_files

- name: wgdashboard | Fix private key permissions
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ privatekey_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: wgdashboard | Fix public key permissions
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: root
    mode: "0644"
  loop: "{{ publickey_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: wgdashboard | Fix config file permissions
  ansible.builtin.file:
    path: "{{ item.path }}"
    owner: root
    group: root
    mode: "0600"
  loop: "{{ config_files.files }}"
  loop_control:
    label: "{{ item.path }}"

- name: wgdashboard | Deploy systemd service
  ansible.builtin.template:
    src: wg-dashboard.service.j2
    dest: /etc/systemd/system/wg-dashboard.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - Reload systemd
    - Restart WGDashboard

- name: wgdashboard | Enable and start WGDashboard
  ansible.builtin.systemd:
    name: wg-dashboard
    enabled: true
    state: started
    daemon_reload: true

- name: wgdashboard | Display access information
  ansible.builtin.debug:
    msg: |
      WGDashboard {{ wgdashboard_version }} installed successfully!

      Access: http://{{ wgdashboard_app_ip }}:{{ wgdashboard_app_port }}

      Credentials:
        Username: {{ wgdashboard_admin_user }}
        Password: {{ '(custom password set)' if wgdashboard_admin_pass_hash != '' else 'admin (CHANGE IT!)' }}

      SSH tunnel for remote access:
        ssh user@{{ inventory_hostname }} -L {{ wgdashboard_app_port }}:127.0.0.1:{{ wgdashboard_app_port }} -N
        Then open: http://localhost:{{ wgdashboard_app_port }}
